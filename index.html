<!DOCTYPE html>
<html>
<head>
  <title>IIUM Gombak Fountain Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    #map { height: 300px; margin-bottom: 30px; }
  </style>
</head>

<body>

<h2>IIUM Gombak Fountain Dashboard</h2>

<div id="map"></div>
<canvas id="levelChart"></canvas>

<script>
  const lat = 3.2470;
  const lng = 101.7432;

  const CHANNEL_ID = 3226119;
  const BOT_TOKEN = "Y8458020155:AAGxKYkkBCW6A7AYBvjd23qqBJGExNzX1Gc";
  const CHAT_ID = 1003491490979;
  const OVERFLOW_THRESHOLD = 30;

  let alertSent = false;

  const map = L.map('map').setView([lat, lng], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const marker = L.marker([lat, lng]).addTo(map)
    .bindPopup("Water Level: Loading...")
    .openPopup();

  const chart = new Chart(document.getElementById("levelChart"), {
    type: "line",
    data: { labels: [], datasets: [{ label: "Water Level (cm)", data: [] }] },
    options: { responsive: true }
  });

  function sendTelegramAlert(message) {
    if (!BOT_TOKEN || !CHAT_ID) return; // ðŸ”’ safety

    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: CHAT_ID,
        text: message
      })
    }).catch(err => console.warn("Telegram blocked:", err));
  }

  function updateDashboard() {
    fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/1.json?results=10`)
      .then(r => r.json())
      .then(data => {
        const labels = [];
        const levels = [];

        data.feeds.forEach(f => {
          if (f.field1 !== null) {
            labels.push(f.created_at);
            levels.push(Number(f.field1));
          }
        });

        chart.data.labels = labels;
        chart.data.datasets[0].data = levels;
        chart.update();

        const latest = levels[levels.length - 1];
        marker.setPopupContent(`Water Level: ${latest} cm`);

        // Telegram alert logic (SAFE)
        if (latest > OVERFLOW_THRESHOLD && !alertSent) {
          alertSent = true;
          sendTelegramAlert("ðŸš¨ Overflow! Fix ASAP");
        }

        if (latest <= OVERFLOW_THRESHOLD) {
          alertSent = false;
        }
      })
      .catch(err => console.error("ThingSpeak error:", err));
  }

  updateDashboard();
  setInterval(updateDashboard, 60000);
</script>

</body>
</html>
